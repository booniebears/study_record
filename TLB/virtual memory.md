## virtual memory

 这是一种将主存用作辅助存储器高速缓存的技术；

可以实现程序地址空间到物理地址的转换；并且由于程序段的划分，可以实现超过重要存储器的容量的程序的成功运行。

块被称为页，缺页代表着所访问的页不在主存储器中。

重中之重：重定位功能

地址的转换过程中，由虚拟地址的虚页号转化为物理地址的物理页号（高位部分），而页偏移不发生变化（低位部分）

设计时需要考虑的因素：1、页尽可能大。2、允许存储器中页以全相连的方式放置来降低缺页率的组织结构。3、软件或算法来替换页。4、写回机制运用

​	段式管理：可变长度的地址映射策略，每个地址都包括映射到物理地址的段号和段内偏移。



### 1、页的存放与查找

当发生页的缺失时，为了避免引起过高代价，我们可以用一个暂时无法用到的页来替代缺页。而寻找这个页的工程就需要运用算法和数据结构知识来确定这个页在短时间内不会被用到，所以替换策略的先进性和灵活性至关重要。

此外，由于项的定位较为困难。我们可以创建一个索引存储器的表来定位这个页（页表）。每个程序中页表将其虚拟地址空间映射到主存中。

## 2、缺页故障

盘存储

LRU（最近最少使用策略）

【本部分仅仅介绍概念，应对策略】

## 3、写

写回机制

## 4、TLB

页表存放在主存中->程序每次访存至少需要两次->先获得物理地址再获得数据

利用访问的局部性来提高这个过程的效率，因此TLB（地址变换高速缓存，快表），即根据已经访问的表对接下来访问情况进行优先选择。

由于我们直接访问TLB而不是页表，所以脏位和引用位也需要包括。

命中：物理页号形成地址，引用位被置位；写操作：脏位被置位;TLB缺失，判断是发生缺页还是仅仅是一次TLB缺失。

如果该页在主存中，那么TLB缺失只是一次转换缺失。在这种情况下，处理器可以通过将页表中的变换装载到TLB中并且重新访问来进行缺失处理。如果该页不在主存中，TLB缺失就是一次真的缺页。在这种情况下，处理器调用操作系统的异常处理。由于TLB中的项比主存中的页数少得多，发生口出缺失会比缺页频繁得多。

在发生了TLB缺失，并且已经在页表中找到了缺失的变化时，我们就需要从TLB中选择一项进行替换。由于TLB表项中包含了引用位和脏位，当替换某一项时，需要把这些位复制回页表项中。这些位是TLB表项中唯一可以修改的部分。利用写回策略,只是在缺失的时候将这些表项写回而不是任何写操作都写回,提高效率。

经典值：

![1649338825499](C:\Users\hesj\AppData\Roaming\Typora\typora-user-images\1649338825499.png)

基本过程：

![1649339251924](C:\Users\hesj\AppData\Roaming\Typora\typora-user-images\1649339251924.png)

## 5、对缺失的分析

在最好的情况下，虚拟地址由TLB进行转换，然后被送到cache,找到相应的数据，取回
并送入处理器。在最坏的情况下，访问在存储器层次结构的TLB、页表和cache这三个部件中
都发生缺失。

对三个缺失的分析：

![1649339473401](C:\Users\hesj\AppData\Roaming\Typora\typora-user-images\1649339473401.png)

注：第一种可能但永远检测不到。

## 6、虚拟存储器中的保护

多进程共享同一个主存，但必须确保一个进程不能写另一个用户进程或者操作系统的地址空间。

TLB写访问就可以实现这个功能。

